<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Resumo do Pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/perfil.css" rel="stylesheet" />
</head>
<body>
  <div class="container checkout-page">
    <div class="site-brand" aria-label="Marca do site">
      <img src="/images/logo.png" alt="AgÃªncia Oppus" class="site-logo logo-dark" />
      <img src="/images/logo escura.png" alt="AgÃªncia Oppus" class="site-logo logo-light" />
      <span class="site-brand-text">AgÃªncia Oppus</span>
    </div>
    <header class="header">
      <h1 class="title">Pedido confirmado</h1>
      <p class="subtitle">Resumo do seu pedido</p>
      <button id="themeToggleBtn" class="theme-toggle" aria-label="Alternar tema">Tema: Escuro</button>
      <a href="/checkout" id="clientFetchBtn" class="client-btn" aria-label="Buscar pedido" style="text-decoration:none;">Cliente</a>
    </header>
    <main class="main-content">
      <section class="section-block">
        <div class="service-card">
          <div class="card-content">
            <h3 class="card-title">InformaÃ§Ãµes do pedido</h3>
            <div class="card-desc" style="font-size: calc(1rem + 1px);">
              <div style="display:grid; gap:0.5rem;">
                <div><strong>Status:</strong> <span id="orderStatus"><%= String(order.status || 'pendente') %></span></div>
                <div><strong>ServiÃ§o:</strong> <span id="orderTipo"><%= String(order.tipo || order.tipoServico || '-') %></span></div>
                <div><strong>Quantidade:</strong> <span id="orderQtd"><%= Number(order.qtd || order.quantidade || 0) %></span></div>
                <div><strong>Instagram:</strong> <span id="orderInsta"><%= String(order.instagramUsername || order.instauser || '-') %></span></div>
                <div><strong>Pago em:</strong> <span id="paidAtLocal">-</span></div>
                <div><strong>NÃºmero do pedido:</strong> <span id="orderNumberId"><%= String((order.fama24h && order.fama24h.orderId) || '-') %></span> <button id="copyOrderBtn" class="button" style="margin-left:8px;padding:4px 8px;font-weight:700;">ðŸ“‹ Copiar</button></div>
              </div>
            </div>
            <div class="button-container" style="margin-top:0.75rem;">
              <button id="backToPrevBtn" class="continue-button" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; margin-right:0.5rem;">
                <span class="button-text">Voltar</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script id="orderDataJson" type="application/json"><%= JSON.stringify(order || {}) %></script>
  <script>
    (function(){
      var orderData = {};
      try { orderData = JSON.parse(document.getElementById('orderDataJson').textContent || '{}'); } catch(_) {}
      var orderId = (orderData && orderData._id) ? String(orderData._id) : null;
      var hasFama = !!(orderData && orderData.fama24h && orderData.fama24h.orderId);
      try {
        var paidRaw = (orderData && orderData.woovi && orderData.woovi.paidAt) || orderData.paidAt || null;
        if (paidRaw) {
          var d = new Date(paidRaw);
          var spTime = new Date(d.getTime() - (3 * 60 * 60 * 1000));
          var dd = String(spTime.getUTCDate()).padStart(2,'0');
          var mm = String(spTime.getUTCMonth()+1).padStart(2,'0');
          var yyyy = spTime.getUTCFullYear();
          var hh = String(spTime.getUTCHours()).padStart(2,'0');
          var min = String(spTime.getUTCMinutes()).padStart(2,'0');
          var txt = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + min;
          var el = document.getElementById('paidAtLocal');
          if (el) el.textContent = txt;
        }
      } catch(_) {}
      function check() {
        var orderIDParam = (orderData && orderData.fama24h && orderData.fama24h.orderId) ? String(orderData.fama24h.orderId) : '';
        var baseUrl = orderIDParam ? ('/api/order?orderID=' + encodeURIComponent(orderIDParam)) : ('/api/order?id=' + encodeURIComponent(String(orderId || '')));
        var url = baseUrl;
        fetch(url)
          .then(function(r){return r.json();})
          .then(function(d){
            try {
              var o = d && d.order ? d.order : null;
              if (!o) return;
              var oid = (o.fama24h && o.fama24h.orderId) ? String(o.fama24h.orderId) : null;
              var paidRaw = (o.woovi && o.woovi.paidAt) || o.paidAt || null;
              var status = String(o.status || o.woovi && o.woovi.status || 'pendente');
              var tipo = String(o.tipo || o.tipoServico || '-');
              var qtd = String(o.qtd || o.quantidade || '0');
              var insta = String(o.instagramUsername || o.instauser || '-');
              var paidStr = null;
              if (paidRaw) {
                try {
                  var d0 = new Date(paidRaw);
                  var sp = new Date(d0.getTime() - (3*60*60*1000));
                  var dd = String(sp.getUTCDate()).padStart(2,'0');
                  var mm = String(sp.getUTCMonth()+1).padStart(2,'0');
                  var yyyy = sp.getUTCFullYear();
                  var hh = String(sp.getUTCHours()).padStart(2,'0');
                  var mn = String(sp.getUTCMinutes()).padStart(2,'0');
                  paidStr = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + mn;
                } catch(_) {}
              }
              var elNum = document.getElementById('orderNumberId');
              if (elNum && oid) elNum.textContent = String(oid);
              var elPaid = document.getElementById('paidAtLocal');
              if (elPaid && paidStr) elPaid.textContent = paidStr;
              var elSt = document.getElementById('orderStatus');
              if (elSt) elSt.textContent = status;
              var elTipo = document.getElementById('orderTipo');
              if (elTipo) elTipo.textContent = tipo;
              var elQtd = document.getElementById('orderQtd');
              if (elQtd) elQtd.textContent = String(qtd);
              var elUser = document.getElementById('orderInsta');
              if (elUser) elUser.textContent = insta;
            } catch(_){}
          })
          .catch(function(){});
      }
      setInterval(check, 8000);
      try { check(); } catch(_) {}
    })();
    (function initCopyOrder(){
      var btn = document.getElementById('copyOrderBtn');
      var span = document.getElementById('orderNumberId');
      if (!btn || !span) return;
      btn.addEventListener('click', function(){
        try {
          var val = (span.textContent || '').trim();
          if (!val) return;
          navigator.clipboard.writeText(val).then(function(){
            try { btn.textContent = 'Copiado'; setTimeout(function(){ btn.textContent = 'ðŸ“‹ Copiar'; }, 1500); } catch(_) {}
          });
        } catch(_) {}
      });
    })();
    (function initBackButton(){
      var btn = document.getElementById('backToPrevBtn');
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          if (window.history && window.history.length > 1) { window.history.back(); return; }
        } catch(_) {}
        try {
          var phone = localStorage.getItem('oppus_client_phone') || '';
          if (phone) { window.location.href = '/cliente'; return; }
        } catch(_) {}
        window.location.href = '/checkout';
      });
    })();
    (function initThemeToggle(){
      var btn = document.getElementById('themeToggleBtn');
      if (!btn) return;
      var applyLabel = function(){
        var isLight = document.body.classList.contains('theme-light');
        btn.textContent = isLight ? 'Tema: Escuro' : 'Tema: Claro';
      };
      try {
        var pref = localStorage.getItem('oppus_theme') || 'dark';
        document.body.classList.toggle('theme-light', pref === 'light');
      } catch(_) {}
      applyLabel();
      btn.addEventListener('click', function(){
        var isLight = document.body.classList.contains('theme-light');
        var next = isLight ? 'dark' : 'light';
        try { localStorage.setItem('oppus_theme', next); } catch(_) {}
        document.body.classList.toggle('theme-light', next === 'light');
        applyLabel();
      });
    })();
  </script>
</body>
</html>