<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Informações do pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link href="/css/style.css?v=2" rel="stylesheet" />
  <link href="/css/perfil.css?v=2" rel="stylesheet" />
  <link rel="icon" type="image/png" href="/images/logo.png" />
  <!-- TRACK COMBO -->
  <script>
    (function() {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.async = true;
      script.src = "https://track.agenciaoppus.site/tag/TC-FQZRKRMP.js";
      var firstScript = document.getElementsByTagName("script")[0];
      firstScript.parentNode.insertBefore(script, firstScript);
    })();
  </script>
  <!-- End TRACK COMBO -->
  <style>
    /* Dark mode contrast improvements for /pedido */
    body:not(.theme-light) .service-card#order-content {
      background-color: #181825 !important; /* Slightly lighter/bluer than base dark */
      border: 1px solid #4B5563 !important; /* Higher contrast border */
    }
    body:not(.theme-light) .info-item > div:first-child,
    body:not(.theme-light) .info-item > span:first-child {
       color: #E2E8F0 !important; /* Brighter secondary text */
    }
    body:not(.theme-light) .status-box-custom {
       background: rgba(107, 70, 193, 0.2) !important;
       border: 1px solid rgba(107, 70, 193, 0.4) !important;
    }
    body:not(.theme-light) .card-title {
        color: #F8FAFC !important;
    }
    body:not(.theme-light) #orderNumberId,
    body:not(.theme-light) #orderTipo, 
    body:not(.theme-light) #orderQtd, 
    body:not(.theme-light) #paidAtLocal,
    body:not(.theme-light) #orderBumpsBox {
        color: #FFFFFF !important;
    }
    /* Approved section text */
    body:not(.theme-light) .approved-payment-section h2 {
        color: #FFFFFF !important;
    }
    body:not(.theme-light) .approved-payment-section p {
        color: #CBD5E1 !important;
    }
    /* Privacy Alert in Dark Mode */
    body:not(.theme-light) #privacyAlertCard {
        background: rgba(69, 26, 3, 0.4) !important; /* Darker orange/brown bg */
        border-color: #92400e !important;
    }
    body:not(.theme-light) #privacyAlertCard strong {
        color: #fbbf24 !important; /* Amber-400 */
    }
    body:not(.theme-light) #privacyAlertCard span {
        color: #fcd34d !important; /* Amber-300 */
    }
    body:not(.theme-light) #privacyAlertCard svg {
        color: #fbbf24 !important;
    }
    /* Improve internal borders and buttons in dark mode */
    body:not(.theme-light) .card-content > div,
    body:not(.theme-light) .info-item,
    body:not(.theme-light) #copyOrderBtn,
    body:not(.theme-light) #backToPrevBtn {
        border-color: #4B5563 !important;
    }
    
    /* Dark Mode Copy Icon White */
    body:not(.theme-light) #copyOrderBtn {
        color: #FFFFFF !important;
        border-color: rgba(255,255,255,0.3) !important;
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
        /* Reduce font size for all data values on mobile */
        #orderTipo, 
        #orderQtd, 
        #orderInsta, 
        #paidAtLocal, 
        #orderTotal, 
        #orderNumberId, 
        #famaServicoStatus,
        #orderBumpsBox {
            font-size: 1rem !important;
        }

        /* Stack Total Value label and price */
        .total-value-row {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 0.25rem !important;
        }
        
        /* Reduce status box padding and font */
        .status-box-custom {
            padding: 1rem !important;
        }
        .status-box-custom span {
            font-size: 1rem !important;
        }
    }
  </style>
</head>
<body class="theme-light has-fixed-menu">
  <!-- Script de remoção de parâmetros removido para permitir F5 (refresh) -->
  <%- include('partials/menu') %>
  <div class="container checkout-page">
    <!-- clientPage removido para forçar redirecionamento para /cliente -->

    <main class="main-content">
      <section class="section-block">

        <% if (String(order.status||order.woovi?.status||'').toLowerCase() === 'pago') { %>
        <div class="approved-payment-section" style="text-align: center; margin: 0 0 2rem 0; animation: fadeInUp 0.6s ease-out;">
            <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; border-radius: 50%; background-color: #22c55e; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3);">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 0 0 0.5rem 0;">Agradecemos pela sua compra!</h2>
            <p style="color: var(--text-secondary); font-size: 1rem; margin: 0;">Acesse nova ferramenta exclusiva para recuperação de seguidores</p>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                
                <% 
                  var tServ = String(order.tipo || order.tipoServico || '').toLowerCase();
                  var isFollower = tServ.includes('seguidores');
                  var isMistoOrBr = tServ.includes('misto') || tServ.includes('brasileiro');
                  var isOrganic = tServ.includes('organico');
                  
                  // Obter telefone para link
                  var phoneForLink = (function(){
                      if (order && order.customer && order.customer.phone) return String(order.customer.phone).replace(/\D/g, '');
                      var map = (order && order.additionalInfoMapPaid) || {};
                      if (map['phone']) return String(map['phone']).replace(/\D/g, '');
                      var arr = (order && order.additionalInfo) || [];
                      var p = arr.find(function(x){ return x.key === 'phone'; });
                      if (p && p.value) return String(p.value).replace(/\D/g, '');
                      return '';
                  })();
                  
                  var refilHref = '/refil';
                  if (order && order.refilLinkId) {
                      refilHref += '?token=' + order.refilLinkId;
                      if (phoneForLink) refilHref += '&phone=' + phoneForLink;
                  } else if (phoneForLink) {
                      refilHref += '?phone=' + phoneForLink;
                  }
                %>
                <a href="<%= refilHref %>" style="display: inline-block; background: var(--instagram-gradient); color: white; padding: 0.75rem 2rem; border-radius: 999px; text-decoration: none; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(220, 39, 67, 0.4);">
                    Acessar ferramenta
                </a>
            </div>
        </div>
        <% } %>
        
        <% if (order && order.profilePrivacy && order.profilePrivacy.isPrivate) { %>
        <div class="service-card" id="privacyAlertCard" style="border: 1px solid #f59e0b; background: rgba(254, 252, 232, 0.5); backdrop-filter: blur(8px); margin-bottom: 2rem;">
          <div class="card-content" style="display: flex; gap: 1rem; align-items: flex-start;">
            <div style="flex-shrink: 0; color: #d97706;">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9V11M12 15H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
               <strong style="display: block; color: #92400e; margin-bottom: 0.25rem;">Perfil Privado Detectado</strong>
               <span style="color: #b45309; font-size: 0.95rem;">Seu perfil do Instagram está privado. Por favor, <strong>altere para público</strong> imediatamente para receber o serviço corretamente e evitar atrasos.</span>
               <button id="retryPrivacyBtn" style="display: inline-block; margin-top: 0.75rem; background: #d97706; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: background 0.2s;">Já deixei público</button>
            </div>
          </div>
        </div>
        <% } %>

        <div class="service-card" id="order-content" style="border: 1px solid var(--border-color); background: var(--bg-secondary); box-shadow: var(--shadow-md);">
          <div class="card-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                <h3 class="card-title" style="margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15M9 5C9 6.10457 9.89543 7 11 7H13C14.1046 7 15 6.10457 15 5M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Detalhes do Pedido
                </h3>
            </div>
            
            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem;">
                
                <div class="info-item">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Serviço Contratado</div>
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary); text-transform: capitalize;" id="orderTipo"><%= String(order.tipo || order.tipoServico || '-') %></div>
                </div>

                <div class="info-item">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Quantidade</div>
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);" id="orderQtd"><%= Number(order.qtd || order.quantidade || 0) %></div>
                </div>

                <div class="info-item">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Perfil Instagram</div>
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary-purple);" id="orderInsta">@<%= (function(){ var map=order.additionalInfoMapPaid||{}; var v=String(map['instagram_username']||'').trim(); if(v){ return v; } return String(order.instagramUsername || order.instauser || '-'); })() %></div>
                </div>

                <div class="info-item">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Data Pagamento</div>
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);" id="paidAtLocal"><%= (function(){ var raw=(order.woovi&&order.woovi.paidAt)||order.paidAt||null; if(!raw) return '-'; try{ var d=new Date(raw); var sp=d; var dd=String(sp.getUTCDate()).padStart(2,'0'); var mm=String(sp.getUTCMonth()+1).padStart(2,'0'); var yyyy=sp.getUTCFullYear(); var hh=String(sp.getUTCHours()).padStart(2,'0'); var mn=String(sp.getUTCMinutes()).padStart(2,'0'); return dd+'/'+mm+'/'+yyyy+' às '+hh+':'+mn; }catch(_){ return '-'; } })() %></div>
                </div>

                <div class="info-item" style="grid-column: 1 / -1; border-top: 1px dashed var(--border-color); padding-top: 1rem;">
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Adicionais</div>
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);" id="orderBumpsBox"><%= (function(){ var arrPaid=Array.isArray(order.additionalInfoPaid)?order.additionalInfoPaid:[]; var arr=Array.isArray(order.additionalInfo)?order.additionalInfo:[]; var map=order.additionalInfoMapPaid||{}; var bs=(function(){ var fp=arrPaid.find(function(it){return it&&it.key==='order_bumps'}); if(fp&&typeof fp.value==='string'&&fp.value) return fp.value; var f=arr.find(function(it){return it&&it.key==='order_bumps'}); if(f&&typeof f.value==='string'&&f.value) return f.value; if(map&&typeof map['order_bumps']==='string'&&map['order_bumps']) return map['order_bumps']; return ''; })(); if(!bs) return 'Nenhum adicional selecionado'; var parts=bs.split(';').map(function(p){return p.trim();}).filter(Boolean); var labels=parts.map(function(p){ var kv=p.split(':'); var k=kv[0]; var v=kv[1]; if(k==='views') return 'Visualizações ('+v+')'; if(k==='likes') return 'Curtidas ('+v+')'; if(k==='comments') return 'Comentários ('+v+')'; return k+' ('+v+')'; }); return labels.join(', '); })() %></div>
                </div>

                <div class="info-item">
                     <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Valor Total</div>
                     <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);" id="orderTotal"><%= (function(){ var totalCents=0; if(typeof order.valueCents==='number' && order.valueCents>0){ totalCents=order.valueCents; } else { var base=0; try{ var pix=order.woovi&&order.woovi.paymentMethods&&order.woovi.paymentMethods.pix; if(pix&&typeof pix.value==='number') base=pix.value; }catch(_){ } var bt=(function(){ var arrPaid=Array.isArray(order.additionalInfoPaid)?order.additionalInfoPaid:[]; var arr=Array.isArray(order.additionalInfo)?order.additionalInfo:[]; var map=order.additionalInfoMapPaid||{}; var fp=arrPaid.find(function(it){return it&&it.key==='order_bumps_total'}); var s=(fp&&typeof fp.value==='string')?fp.value:''; if(!s){ var f=arr.find(function(it){return it&&it.key==='order_bumps_total'}); s=(f&&typeof f.value==='string')?f.value:''; } if(!s && map && typeof map['order_bumps_total']==='string') s=map['order_bumps_total']; if(!s) return 0; var m=s.match(/(\d+)[,\.]?(\d{0,2})/); if(!m) return 0; var whole=Number(m[1]); var frac=String(m[2]||'').padEnd(2,'0').slice(0,2); return (whole*100)+Number(frac); })(); totalCents=base+bt; } if(totalCents>0){ var reais=Math.floor(totalCents/100); var cents=String(totalCents%100).padStart(2,'0'); return 'R$ '+reais+','+cents; } return '-'; })() %></div>
                </div>
                
                <div class="info-item" style="grid-column: 1 / -1; margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                   <span style="font-size: 0.75rem; color: var(--text-secondary);">ID do Pedido</span>
                   <div style="display: flex; align-items: center; gap: 0.25rem;">
                       <span style="font-family: monospace; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);" id="orderNumberId"><%= (function(){ 
                           var oidF=(order&&order.fama24h&&order.fama24h.orderId)?String(order.fama24h.orderId):''; 
                           var oidFS=(order&&order.fornecedor_social&&order.fornecedor_social.orderId)?String(order.fornecedor_social.orderId):''; 
                           var functionalOid = oidF||oidFS;
                           return String(functionalOid || ''); 
                       })() %></span>
                       <div style="position: relative; display: flex; align-items: center;">
                           <button id="copyOrderBtn" class="copy-icon-btn" aria-label="Copiar número do pedido" style="background: transparent; border: none; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; cursor: pointer;">
                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="7" y="7" width="10" height="10" rx="2" fill="currentColor"/><rect x="3" y="3" width="10" height="10" rx="2" fill="currentColor" opacity="0.4"/></svg>
                           </button>
                           <span id="copyFeedback" style="opacity: 0; pointer-events: none; transition: opacity 0.3s; position: absolute; left: 100%; margin-left: 8px; background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; z-index: 10;">Copiado!</span>
                       </div>
                   </div>
                </div>
                
                 <% var famaPayload=(order&&order.fama24h&&order.fama24h.statusPayload)||null; var sRaw=String((famaPayload&&(famaPayload.status||famaPayload.Status||famaPayload.status_text||famaPayload.statusText||famaPayload.StatusText))||'').trim(); var t=sRaw.toLowerCase(); var stMap=t?(/cancel/.test(t)?'Cancelado':(/partial/.test(t)?'Parcial':(/pend/.test(t)?'Pendente':(/process|progress|start|running/.test(t)?'Em andamento':(/complete|success|finished|done/.test(t)?'Concluído':sRaw))))):'-'; %>
                <div class="info-item status-box-custom" style="grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; background: rgba(107, 70, 193, 0.1); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(107, 70, 193, 0.2);">
                    <span style="font-size: 1rem; font-weight: 500; color: var(--primary-purple); font-family: inherit;">Status do Serviço</span>
                    <span id="famaServicoStatus" class="status-badge <%= (stMap==='Concluído'?'status-green':(stMap==='Cancelado'?'status-red':(stMap==='Em andamento'?'status-yellow':(stMap==='Pendente'?'status-blue':'')))) %>" style="font-size: 1rem; font-weight: 500; letter-spacing: 0.05em; font-family: inherit;"><%= stMap %></span>
                </div>

            </div>
            
            <div class="button-container" style="margin-top:1.5rem; display: flex; justify-content: center;">
              <button id="backToPrevBtn" class="continue-button" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; background: var(--instagram-gradient); color: white; border: none; box-shadow: 0 4px 6px -1px rgba(220, 39, 67, 0.4); transition: transform 0.2s;">
                <span class="button-text">Voltar</span>
              </button>
            </div>
          </div>
        </div>


      </section>
    </main>
  </div>
  <script id="orderDataJson" type="application/json"><%= JSON.stringify(order || {}) %></script>
  <script>
    (function(){
      var orderData = {};
      try { orderData = JSON.parse(document.getElementById('orderDataJson').textContent || '{}'); } catch(_) {}
      var orderId = (orderData && orderData._id) ? String(orderData._id) : null;
      var hasFama = !!(orderData && orderData.fama24h && orderData.fama24h.orderId);
      var lastFamaStatus = '';
      try {
        var oidToSave = null;
        if (hasFama) oidToSave = String(orderData.fama24h.orderId);
        else if (orderData && orderData.fornecedor_social && orderData.fornecedor_social.orderId) oidToSave = String(orderData.fornecedor_social.orderId);
        else if (orderId) oidToSave = String(orderId);
        else if (orderData && orderData.identifier) oidToSave = String(orderData.identifier);

        if (oidToSave) localStorage.setItem('oppus_selected_oid', oidToSave);
      } catch(_) {}
      try {
        var initialFama = (orderData && orderData.fama24h && orderData.fama24h.statusPayload) ? orderData.fama24h.statusPayload : null;
        var elFamaInit = document.getElementById('famaServicoStatus');
        var mapFamaInit = function(s){
          var t = String(s || '').toLowerCase();
          if (!t) return '';
          if (/cancel/.test(t)) return 'Cancelado';
          if (/partial/.test(t)) return 'Parcial';
          if (/pend/.test(t)) return 'Pendente';
          if (/process|progress|start|running/.test(t)) return 'Em andamento';
          if (/complete|success|finished|done/.test(t)) return 'Concluído';
          return s;
        };
        if (initialFama && elFamaInit) {
          var raw0 = String(initialFama.status || initialFama.Status || initialFama.status_text || initialFama.statusText || initialFama.StatusText || '').trim();
          var st0 = mapFamaInit(raw0);
          if (st0) {
            lastFamaStatus = st0;
            elFamaInit.textContent = st0;
            try {
              elFamaInit.classList.remove('status-green','status-yellow','status-red','status-blue');
              var s0 = st0.toLowerCase();
              if (/conclu/.test(s0)) elFamaInit.classList.add('status-green');
              else if (/cancel/.test(s0)) elFamaInit.classList.add('status-red');
              else if (/andament|process|progress|start|running/.test(s0)) elFamaInit.classList.add('status-yellow');
              else if (/pend/.test(s0)) elFamaInit.classList.add('status-blue');
            } catch(_){ }
          }
        }
      } catch(_) {}
      try {
        var paidRaw = (orderData && orderData.woovi && orderData.woovi.paidAt) || orderData.paidAt || null;
        if (paidRaw) {
          var d = new Date(paidRaw);
          var spTime = d;
          var dd = String(spTime.getUTCDate()).padStart(2,'0');
          var mm = String(spTime.getUTCMonth()+1).padStart(2,'0');
          var yyyy = spTime.getUTCFullYear();
          var hh = String(spTime.getUTCHours()).padStart(2,'0');
          var min = String(spTime.getUTCMinutes()).padStart(2,'0');
          var txt = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + min;
          var el = document.getElementById('paidAtLocal');
          if (el) el.textContent = txt;
        }
      } catch(_) {}
      
      // Retry Privacy Button
      (function(){
        var btn = document.getElementById('retryPrivacyBtn');
        if (!btn) return;
        btn.addEventListener('click', function(){
            btn.disabled = true;
            var originalText = btn.textContent;
            btn.textContent = 'Verificando...';
            var idToUse = (orderData && (orderData.identifier || orderData._id)) || null;
            if (!idToUse) {
                alert('Erro: ID do pedido não encontrado.');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }
            fetch('/api/order/retry-fulfillment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ identifier: idToUse })
            })
            .then(function(r){ return r.json(); })
            .then(function(data){
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Ainda não identificamos o perfil como público. Aguarde uns instantes e tente novamente.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })
            .catch(function(err){
                console.error(err);
                alert('Erro de conexão. Tente novamente.');
                btn.disabled = false;
                btn.textContent = originalText;
            });
        });
      })();

      try {
        var tipoServ = String((orderData && (orderData.tipo || orderData.tipoServico)) || '').toLowerCase();
        var alreadyFS = !!(orderData && orderData.fornecedor_social && orderData.fornecedor_social.orderId);
        var isPaid = String((orderData && (orderData.status || (orderData.woovi && orderData.woovi.status))) || '').toLowerCase() === 'pago';
        var ident = String((orderData && (orderData.identifier || (orderData.woovi && orderData.woovi.identifier))) || '').trim();
        try {
          var qs = new URLSearchParams((location && location.search) || '');
          var identQ = String(qs.get('identifier') || qs.get('t') || '').trim();
          var corrQ = String(qs.get('correlationID') || qs.get('ref') || '').trim();
          if (!ident && identQ) ident = identQ;
          if (!corrQ && (orderData && orderData.correlationID)) corrQ = String(orderData.correlationID || '').trim();
          if (ident) {
            var es = new EventSource('/api/payment/subscribe?identifier=' + encodeURIComponent(ident));
            es.addEventListener('paid', function(ev){
              try {
                var data = JSON.parse(ev.data || '{}');
                var oidFS = String(data && data.fornecedor_social_orderId ? data.fornecedor_social_orderId : '');
                var oidFama = String(data && data.fama24h_orderId ? data.fama24h_orderId : '');
                var oid = String(oidFS || oidFama || '');
                if (oid) {
                  var elNumber = document.getElementById('orderNumberId');
                  if (elNumber) elNumber.textContent = oid;
                  try { localStorage.setItem('oppus_selected_oid', oid); } catch(_){}
                }
              } catch(_){}
            });
          } else if (corrQ) {
            var es2 = new EventSource('/api/payment/subscribe?correlationID=' + encodeURIComponent(corrQ));
            es2.addEventListener('paid', function(ev){
              try {
                var data = JSON.parse(ev.data || '{}');
                var oidFS = String(data && data.fornecedor_social_orderId ? data.fornecedor_social_orderId : '');
                var oidFama = String(data && data.fama24h_orderId ? data.fama24h_orderId : '');
                var oid = String(oidFS || oidFama || '');
                if (oid) {
                  var elNumber = document.getElementById('orderNumberId');
                  if (elNumber) elNumber.textContent = oid;
                  try { localStorage.setItem('oppus_selected_oid', oid); } catch(_){}
                }
              } catch(_){}
            });
          }
        } catch(_){}
        try {
          if (ident) {
            var es = new EventSource('/api/payment/subscribe?identifier=' + encodeURIComponent(ident));
            es.addEventListener('paid', function(ev){
              try {
                var data = JSON.parse(ev.data || '{}');
                var oidFS = String(data && data.fornecedor_social_orderId ? data.fornecedor_social_orderId : '');
                var oidFama = String(data && data.fama24h_orderId ? data.fama24h_orderId : '');
                var oid = String(oidFS || oidFama || '');
                if (oid) {
                  var elNumber = document.getElementById('orderNumberId');
                  if (elNumber) elNumber.textContent = oid;
                  try { localStorage.setItem('oppus_selected_oid', oid); } catch(_){}
                }
              } catch(_){}
            });
          }
        } catch(_){}
        
        (function(){
          var tries = 0;
          var maxTries = 20;
          function refreshOrderFS(){
            tries++;
            if (!ident) return;
            fetch('/api/order?identifier=' + encodeURIComponent(ident))
              .then(function(r){ return r.json(); })
              .then(function(d){
                try {
                  var o = d && d.order ? d.order : null;
                  if (!o) return;
                  var oidFS = (o && o.fornecedor_social && o.fornecedor_social.orderId) ? String(o.fornecedor_social.orderId) : '';
                  if (oidFS) {
                    var elNumber = document.getElementById('orderNumberId');
                    if (elNumber) elNumber.textContent = oidFS;
                    try { localStorage.setItem('oppus_selected_oid', oidFS); } catch(_){}
                  }
                } catch(_){ }
              })
              .catch(function() {})
              .finally(function(){ if (tries < maxTries) setTimeout(refreshOrderFS, 1500); });
          }
          if (isPaid && tipoServ === 'organicos') setTimeout(refreshOrderFS, 1200);
        })();
      } catch(_) {}
      function check() {
        var cachedOid = null;
        try { cachedOid = localStorage.getItem('oppus_selected_oid') || null; } catch(_) {}
        var orderIDParam = cachedOid || ((orderData && orderData.fama24h && orderData.fama24h.orderId) ? String(orderData.fama24h.orderId) : ((orderData && orderData.fornecedor_social && orderData.fornecedor_social.orderId) ? String(orderData.fornecedor_social.orderId) : ((orderData && orderData._id) ? String(orderData._id) : '')));
        if (!orderIDParam) return;
        var url = '/api/order?orderID=' + encodeURIComponent(orderIDParam);
        fetch(url)
          .then(function(r){return r.json();})
          .then(function(d){
            try {
              var o = d && d.order ? d.order : null;
              if (!o) return;
              var providerOid = (o.fama24h && o.fama24h.orderId) ? String(o.fama24h.orderId) : ((o.fornecedor_social && o.fornecedor_social.orderId) ? String(o.fornecedor_social.orderId) : null);
              var shortId = (o._id && String(o._id).length > 8) ? '#' + String(o._id).slice(-8).toUpperCase() : String(o._id || '-');
              var oid = providerOid || shortId;
              var paidRaw = (o.woovi && o.woovi.paidAt) || o.paidAt || null;
              var status = String(o.status || o.woovi && o.woovi.status || 'pendente');
              var tipo = String(o.tipo || o.tipoServico || '-');
              var qtd = String(o.qtd || o.quantidade || '0');
              var insta = String(o.instagramUsername || o.instauser || '-');
              var paidStr = null;
              if (paidRaw) {
                try {
                  var d0 = new Date(paidRaw);
                  var sp = d0;
                  var dd = String(sp.getUTCDate()).padStart(2,'0');
                  var mm = String(sp.getUTCMonth()+1).padStart(2,'0');
                  var yyyy = sp.getUTCFullYear();
                  var hh = String(sp.getUTCHours()).padStart(2,'0');
                  var mn = String(sp.getUTCMinutes()).padStart(2,'0');
                  paidStr = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + mn;
                } catch(_) {}
              }
              var elNum = document.getElementById('orderNumberId');
              if (elNum && oid) elNum.textContent = String(oid);
              var elPaid = document.getElementById('paidAtLocal');
              if (elPaid && paidStr) elPaid.textContent = paidStr;
              var elSt = document.getElementById('orderStatus');
              if (elSt) {
                var s = String(status||'').toLowerCase();
                elSt.textContent = s==='pago' ? 'pedido pago' : status;
                try {
                  elSt.classList.toggle('status-green', s==='pago');
                  elSt.classList.toggle('status-yellow', s==='pendente');
                } catch(_) {}
              }
              var elTipo = document.getElementById('orderTipo');
              if (elTipo) elTipo.textContent = tipo;
              var elQtd = document.getElementById('orderQtd');
              if (elQtd) elQtd.textContent = String(qtd);
              var elUser = document.getElementById('orderInsta');
              if (elUser) elUser.textContent = insta;
              try {
                var getAddVal = function(obj, key){
                  var arrPaid = Array.isArray(obj && obj.additionalInfoPaid) ? obj.additionalInfoPaid : [];
                  var arr = Array.isArray(obj && obj.additionalInfo) ? obj.additionalInfo : [];
                  var mapPaid = obj && obj.additionalInfoMapPaid || {};
                  var foundPaid = arrPaid.find(function(it){ return it && it.key === key; });
                  if (foundPaid && typeof foundPaid.value === 'string') return foundPaid.value;
                  var found = arr.find(function(it){ return it && it.key === key; });
                  if (found && typeof found.value === 'string') return found.value;
                  if (mapPaid && typeof mapPaid[key] === 'string') return mapPaid[key];
                  return '';
                };
                var bumpsStr = getAddVal(o, 'order_bumps');
                var bumpsTotal = getAddVal(o, 'order_bumps_total');
                var baseCents = 0;
                var hasTotal = false;
                try {
                  if (typeof o.valueCents === 'number' && o.valueCents > 0) { baseCents = o.valueCents; hasTotal = true; }
                  else if (o.woovi && o.woovi.paymentMethods && o.woovi.paymentMethods.pix && typeof o.woovi.paymentMethods.pix.value === 'number') { baseCents = o.woovi.paymentMethods.pix.value; }
                } catch(_) {}
                var bumpsCents = 0;
                if (typeof bumpsTotal === 'string' && bumpsTotal) {
                  var m = bumpsTotal.match(/(\d+)[,\.]?(\d{0,2})/);
                  if (m) {
                    var whole = Number(m[1]);
                    var frac = String(m[2]||'');
                    var frac2 = frac.padEnd(2,'0').slice(0,2);
                    bumpsCents = (whole*100) + Number(frac2);
                  }
                }
                var totalCents = hasTotal ? baseCents : (baseCents + bumpsCents);
                var totalStr = '-';
                if (totalCents > 0) {
                  var reais = Math.floor(totalCents/100);
                  var cents = String(totalCents%100).padStart(2,'0');
                  totalStr = 'R$ ' + reais + ',' + cents;
                }
                var elB = document.getElementById('orderBumpsBox');
                var elBT = document.getElementById('orderBumpsTotal');
                var elTot = document.getElementById('orderTotal');
                if (elBT) { elBT.textContent = bumpsTotal || '-'; }
                if (elTot) { elTot.textContent = totalStr; }
                if (elB) {
                  if (typeof bumpsStr === 'string' && bumpsStr) {
                    var parts = bumpsStr.split(';').map(function(p){ return p.trim(); }).filter(Boolean);
                    var labels = parts.map(function(p){
                      var kv = p.split(':');
                      var k = kv[0];
                      var v = kv[1];
                      if (k === 'views') return 'Visualizações Reels (' + v + ')';
                      if (k === 'likes') return 'Curtidas (' + v + ')';
                      if (k === 'comments') return 'Comentários (' + v + ')';
                      return k + ' (' + v + ')';
                    });
                    elB.textContent = labels.join(', ');
                  } else {
                    elB.textContent = '-';
                  }
                }
                try {
                  var elFama = document.getElementById('famaServicoStatus');
                  var elLabel = document.getElementById('famaServicoLabel');
                  var famaPollTimer = null;
                  var shouldPoll = function(state){
                    var s = String(state || lastFamaStatus || '').toLowerCase();
                    return /pend/.test(s) || /andament|process|progress|start|running/.test(s);
                  };
                  var schedulePoll = function(){
                    try { if (famaPollTimer) { clearInterval(famaPollTimer); famaPollTimer = null; } } catch(_){}
                    if (shouldPoll()) {
                      try { famaPollTimer = setInterval(check, 120000); } catch(_){}
                    }
                  };
                  var mapFama = function(s){
                    var t = String(s || '').toLowerCase();
                    if (!t) return '-';
                    if (/cancel/.test(t)) return 'Cancelado';
                    if (/partial/.test(t)) return 'Parcial';
                    if (/pend/.test(t)) return 'Pendente';
                    if (/process|progress|start|running/.test(t)) return 'Em andamento';
                    if (/complete|success|finished|done/.test(t)) return 'Concluído';
                    return s;
                  };
                  var updateFama = function(resp){
                    if (!elFama || !resp) return;
                    var raw = String(resp.status || resp.Status || resp.status_text || resp.statusText || resp.StatusText || '').trim();
                    var st = mapFama(raw);
                    if (st) { lastFamaStatus = st; }
                    var show = lastFamaStatus || st || '-';
                    elFama.textContent = show;
                    try {
                      elFama.classList.remove('status-green','status-yellow','status-red','status-blue');
                      var s1 = show.toLowerCase();
                      if (/conclu/.test(s1)) elFama.classList.add('status-green');
                      else if (/cancel/.test(s1)) elFama.classList.add('status-red');
                      else if (/andament|process|progress|start|running/.test(s1)) elFama.classList.add('status-yellow');
                      else if (/pend/.test(s1)) elFama.classList.add('status-blue');
                    } catch(_){ }
                    if (elLabel) {
                      elLabel.textContent = show;
                    }
                    schedulePoll();
                  };
                  try {
                    var persisted = o && o.fama24h && o.fama24h.statusPayload ? o.fama24h.statusPayload : null;
                    if (persisted) {
                      var rawPersist = String(persisted.status || persisted.Status || persisted.status_text || persisted.statusText || persisted.StatusText || '').trim();
                      var stPersist = mapFama(rawPersist);
                      if (stPersist) {
                        lastFamaStatus = stPersist;
                        if (elLabel) elLabel.textContent = stPersist;
                        if (elFama) elFama.textContent = stPersist;
                        try {
                          elFama.classList.remove('status-green','status-yellow','status-red','status-blue');
                          var s2 = stPersist.toLowerCase();
                          if (/conclu/.test(s2)) elFama.classList.add('status-green');
                          else if (/cancel/.test(s2)) elFama.classList.add('status-red');
                          else if (/andament|process|progress|start|running/.test(s2)) elFama.classList.add('status-yellow');
                          else if (/pend/.test(s2)) elFama.classList.add('status-blue');
                        } catch(_){ }
                        schedulePoll();
                      }
                    }
                  } catch(_){ }
                  if (oid && shouldPoll()) {
                    try { console.debug('Fama status request', { order: String(oid) }); } catch(_) {}
                    fetch('/api/fama/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order: String(oid) }) })
                      .then(function(r){ return r.json(); })
                      .then(function(x){ try { console.debug('Fama status response', x); } catch(_) {} try { updateFama(x && x.data); } catch(_) {} })
                      .catch(function(){});
                  }
                } catch(_) {}
              } catch(_) {}
            } catch(_){}
          })
          .catch(function(){});
      }
      try { check(); } catch(_) {}
      try {
        var cachedOid2 = null;
        try { cachedOid2 = localStorage.getItem('oppus_selected_oid') || null; } catch(_) {}
        var hasOid = cachedOid2 || ((orderData && orderData.fama24h && orderData.fama24h.orderId) ? String(orderData.fama24h.orderId) : '') || '';
        if (hasOid && (String(lastFamaStatus || '').toLowerCase().match(/pend/) || String(lastFamaStatus || '').toLowerCase().match(/andament|process|progress|start|running/))) {
          setInterval(check, 120000);
        }
      } catch(_) {}
    })();
    (function initCopyOrder(){
      var btn = document.getElementById('copyOrderBtn');
      var span = document.getElementById('orderNumberId');
      if (!btn || !span) return;
      btn.addEventListener('click', function(){
        try {
          var val = (span.textContent || '').trim();
          if (!val) return;
          navigator.clipboard.writeText(val).then(function(){
            try { 
                var fb = document.getElementById('copyFeedback');
                if (fb) fb.style.opacity = '1';
                setTimeout(function(){ if (fb) fb.style.opacity = '0'; }, 2000);
            } catch(_) {}
          });
        } catch(_) {}
      });
    })();
    (function initBackButton(){
      var btn = document.getElementById('backToPrevBtn');
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          if (window.history && window.history.length > 1) { window.history.back(); return; }
        } catch(_) {}
        try {
          var phone = localStorage.getItem('oppus_client_phone') || '';
          if (phone) { window.location.href = '/cliente'; return; }
        } catch(_) {}
        window.location.href = '/checkout';
      });
    })();
  </script>

<!-- Privacy Check Modal -->
<div id="privacyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; align-items:center; justify-content:center; padding:1rem; backdrop-filter: blur(5px);">
  <div style="background:var(--bg-secondary); padding:2rem; border-radius:16px; max-width:400px; width:100%; text-align:center; position:relative; box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border: 1px solid var(--border-color);">
    
    <!-- Step 1: Initial Warning -->
    <div id="privacyStep1">
      <div style="width:64px; height:64px; background:#FEF3C7; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:1.5rem; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.2);">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      </div>
      <h3 style="margin:0 0 0.75rem 0; color:var(--text-primary); font-size: 1.25rem; font-weight: 700;">Perfil Privado Detectado</h3>
      <div style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 1rem; font-weight: 600;">@<%= (function(){ var map=order.additionalInfoMapPaid||{}; var v=String(map['instagram_username']||'').trim(); if(v){ return v; } return String(order.instagramUsername || order.instauser || '-'); })() %></div>
      <p style="color:var(--text-secondary); margin-bottom:2rem; line-height: 1.5;">Deixe o seu perfil no modo publico para receber o serviços. Apos ficar no modo publico retorne nessa tela e clique em confirmar para confirmamos que esta publico.</p>
      <button id="btnConfirmPrivacy" onclick="checkPrivacyStatus()" class="continue-button" style="width:100%; justify-content:center; margin-top:1rem;">
        <span class="button-text">Confirmar</span>
      </button>
    </div>

    <!-- Step 2: Loading -->
    <div id="privacyStepLoading" style="display:none; padding: 1rem 0;">
      <div class="spinner" style="border: 3px solid rgba(0,0,0,0.1); width: 48px; height: 48px; border-radius: 50%; border-left-color: #22c55e; animation: spin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
      <h3 style="margin:0 0 0.5rem 0; color:var(--text-primary); font-size: 1.1rem;">Verificando perfil...</h3>
      <p style="color:var(--text-secondary);">Aguarde um momento</p>
    </div>

    <!-- Step 3: Still Private (Timer) -->
    <div id="privacyStepError" style="display:none;">
      <div style="width:64px; height:64px; background:#FEE2E2; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:1.5rem;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </div>
      <h3 style="margin:0 0 0.75rem 0; color:var(--text-primary); font-size: 1.25rem; font-weight: 700;">O PERFIL ainda está privado</h3>
      <div style="font-size: 1.2rem; color: var(--text-primary); margin-bottom: 1rem; font-weight: 600;">@<%= (function(){ var map=order.additionalInfoMapPaid||{}; var v=String(map['instagram_username']||'').trim(); if(v){ return v; } return String(order.instagramUsername || order.instauser || '-'); })() %></div>
      <p style="color:var(--text-secondary); margin-bottom:2rem; line-height: 1.5;">Você não deixou seu perfil no modo público, deixe-o no modo público e retorne nessa tela para confirmar e finalizar o recebimento do serviço</p>
      
      <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1.5rem; font-feature-settings: 'tnum'; font-variant-numeric: tabular-nums;">
        0:<span id="privacyTimer">59</span>
      </div>

      <button disabled style="width:100%; background:var(--bg-primary); color:var(--text-secondary); border:1px solid var(--border-color); padding:1rem; border-radius:12px; font-weight:600; cursor:not-allowed; font-size:1rem; opacity: 0.7;">
        Aguarde...
      </button>
    </div>

  </div>
</div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

</style>

<script>
(function() {
  var orderData = {};
  try { orderData = JSON.parse(document.getElementById('orderDataJson').textContent || '{}'); } catch(_) {}
  
  // DEBUG: Verificar dados de privacidade no console
  console.log('OrderData Privacy Check:', {
      username: orderData.instagramUsername || orderData.instauser,
      profilePrivacy: orderData.profilePrivacy,
      isPrivate: orderData.profilePrivacy && orderData.profilePrivacy.isPrivate
  });

  // Verifica se o perfil está marcado como privado
  if (orderData && orderData.profilePrivacy && orderData.profilePrivacy.isPrivate) {
    var modal = document.getElementById('privacyModal');
    if (modal) {
      modal.style.display = 'flex';
      // Prevenir scroll do body
      document.body.style.overflow = 'hidden';
    }
  } else {
    // FALLBACK: Se o card de alerta existir no DOM (renderizado pelo EJS),
    // ENTÃO o perfil É privado, não importa o que o JSON diga.
    var alertCard = document.getElementById('privacyAlertCard');
    if (alertCard) {
        var modal = document.getElementById('privacyModal');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    } else {
        // Se o sistema acha que é público (ou não sabe), mas queremos garantir:
        // Fazemos uma checagem "silenciosa" na API ao carregar.
        // Se a API retornar que é privado, abrimos o modal.
        
        // --- Reutilizando lógica de username robusta ---
        var uname = '';
        if (orderData.additionalInfoMapPaid && orderData.additionalInfoMapPaid['instagram_username']) {
            uname = orderData.additionalInfoMapPaid['instagram_username'];
        }
        if (!uname && Array.isArray(orderData.additionalInfoPaid)) {
            var found = orderData.additionalInfoPaid.find(function(i){ return i && i.key === 'instagram_username'; });
            if (found && found.value) uname = found.value;
        }
        if (!uname && Array.isArray(orderData.additionalInfo)) {
            var found = orderData.additionalInfo.find(function(i){ return i && i.key === 'instagram_username'; });
            if (found && found.value) uname = found.value;
        }
        if (!uname) {
            uname = orderData.instagramUsername || orderData.instauser || orderData.link || '';
        }
        // FALLBACK DOM
        if (!uname) {
            var elInsta = document.getElementById('orderInsta');
            if (elInsta) {
                uname = elInsta.textContent || elInsta.innerText || '';
            }
        }
        
        if (uname) {
            uname = String(uname).replace(/\/$/, '');
            var parts = uname.split('/');
            uname = parts[parts.length - 1];
            uname = uname.replace('@', '').trim();
        }
        // -----------------------------------------------
        
        if (uname) {
            fetch('/api/check-privacy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: uname })
            })
            .then(function(r){ return r.json(); })
            .then(function(d){
                if (d && d.isPrivate === true) {
                    console.log('Silent check detected Private profile!');
                    var modal = document.getElementById('privacyModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                }
            })
            .catch(function(e){ console.error('Silent check error', e); });
        }
    }
  }
})();

var privacyTimerInterval = null;

function checkPrivacyStatus() {
  var orderData = {};
  try { orderData = JSON.parse(document.getElementById('orderDataJson').textContent || '{}'); } catch(_) {}
  
  // Obter username (lógica robusta)
  var username = '';
  
  // 1. Tentar mapa direto
  if (orderData.additionalInfoMapPaid && orderData.additionalInfoMapPaid['instagram_username']) {
      username = orderData.additionalInfoMapPaid['instagram_username'];
  }
  
  // 2. Tentar arrays de info (Paid e Normal)
  if (!username && Array.isArray(orderData.additionalInfoPaid)) {
      var found = orderData.additionalInfoPaid.find(function(i){ return i && i.key === 'instagram_username'; });
      if (found && found.value) username = found.value;
  }
  if (!username && Array.isArray(orderData.additionalInfo)) {
      var found = orderData.additionalInfo.find(function(i){ return i && i.key === 'instagram_username'; });
      if (found && found.value) username = found.value;
  }

  // 3. Tentar campos diretos
  if (!username) {
      username = orderData.instagramUsername || orderData.instauser || orderData.link || '';
  }

  // 4. FALLBACK DOM: Tentar pegar do elemento visual
  if (!username) {
      var elInsta = document.getElementById('orderInsta');
      if (elInsta) {
          username = elInsta.textContent || elInsta.innerText || '';
      }
  }
  
  // Limpeza (caso venha url completa)
  if (username) {
      username = String(username).replace(/\/$/, ''); // remove trailing slash
      var parts = username.split('/');
      username = parts[parts.length - 1]; // pega última parte se for url
      username = username.replace('@', '').trim();
  }

  if (!username) {
      alert('Não foi possível identificar o usuário do Instagram.');
      return;
  }

  // UI Updates
  document.getElementById('privacyStep1').style.display = 'none';
  document.getElementById('privacyStepLoading').style.display = 'block';

  fetch('/api/check-privacy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: username })
  })
  .then(function(res) { return res.json(); })
  .then(function(data) {
      if (data.success && data.isPrivate === false) {
          // Success: Profile is Public
          
          // Dispatch fulfillment retry (Trigger services)
          var id = orderData.identifier || orderData.woovi?.identifier || orderData._id;
          if (id) {
             console.log('🔄 Initiating fulfillment retry for ID:', id);
             fetch('/api/order/retry-fulfillment', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ identifier: id })
             })
             .then(function(r){ return r.json(); })
             .then(function(d){ 
                 console.log('✅ Fulfillment retry initiated:', d); 
                 if (d.error) console.error('❌ Retry error:', d.error);
             })
             .catch(function(e){ console.error('❌ Retry fulfillment fetch error', e); });
          } else {
             console.error('❌ No identifier found for retry fulfillment', orderData);
          }

          // Close modal
          document.getElementById('privacyModal').style.display = 'none';
          document.body.style.overflow = '';
          
          // Remove alert card if exists
          var alertCard = document.getElementById('privacyAlertCard');
          if (alertCard) alertCard.remove();
          
          // Reload page to update status? Maybe just remove alert is enough for now.
          // Optional: setTimeout(function(){ location.reload(); }, 2000);
          
      } else {
          // Still Private or Error
          showPrivacyError();
      }
  })
  .catch(function(err) {
      console.error(err);
      showPrivacyError();
  });
}

function showPrivacyError() {
  document.getElementById('privacyStepLoading').style.display = 'none';
  document.getElementById('privacyStepError').style.display = 'block';
  
  startPrivacyTimer(59);
}

function startPrivacyTimer(seconds) {
  var timerEl = document.getElementById('privacyTimer');
  var timeLeft = seconds;
  
  timerEl.textContent = timeLeft < 10 ? '0' + timeLeft : timeLeft;
  
  if (privacyTimerInterval) clearInterval(privacyTimerInterval);
  
  privacyTimerInterval = setInterval(function() {
    timeLeft--;
    timerEl.textContent = timeLeft < 10 ? '0' + timeLeft : timeLeft;
    
    if (timeLeft <= 0) {
      clearInterval(privacyTimerInterval);
      // Reset to Step 1
      document.getElementById('privacyStepError').style.display = 'none';
      document.getElementById('privacyStep1').style.display = 'block';
    }
  }, 1000);
}
</script>
<script src="/js/checkout.js"></script>
  <script src="/js/main.js"></script>
</body>
</html>