<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Informações do pedido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/perfil.css" rel="stylesheet" />
  
</head>
<body>
  <div class="container checkout-page">
    <div class="site-brand" aria-label="Marca do site">
      <img src="/images/logo.png" alt="Agência Oppus" class="site-logo logo-dark" />
      <img src="/images/logo escura.png" alt="Agência Oppus" class="site-logo logo-light" />
      <span class="site-brand-text">Agência Oppus</span>
    </div>
    <header class="header">
      <h1 class="title">Informações do pedido</h1>
      <p class="subtitle">Resumo do seu pedido</p>
      <button id="themeToggleBtn" class="theme-toggle" aria-label="Alternar tema">Tema: Escuro</button>
      <a href="/checkout" id="clientFetchBtn" class="client-btn" aria-label="Buscar pedido" style="text-decoration:none;">Cliente</a>
    </header>
    <main class="main-content">
      <section class="section-block">
        <div class="service-card">
          <div class="card-content">
            <h3 class="card-title">Informações do pedido</h3>
            <div class="card-desc" style="font-size: calc(1rem + 1px); font-family: var(--font-family);">
              <div style="display:grid; gap:0.5rem;">
                <div>Status: <span id="orderStatus" class="status-text <%= ((String(order.status||order.woovi?.status||'').toLowerCase()==='pago') ? 'status-green' : (String(order.status||order.woovi?.status||'').toLowerCase()==='pendente' ? 'status-yellow' : '')) %>"><%= (String(order.status||order.woovi?.status||'').toLowerCase()==='pago' ? 'pedido pago' : String(order.status || order.woovi?.status || 'pendente')) %></span></div>
                <div>Serviço: <span id="orderTipo"><%= String(order.tipo || order.tipoServico || '-') %></span></div>
                <div>Quantidade: <span id="orderQtd"><%= Number(order.qtd || order.quantidade || 0) %></span></div>
                <div>Instagram: <span id="orderInsta"><%= String(order.instagramUsername || order.instauser || '-') %></span></div>
                <div>Pago em: <span id="paidAtLocal">-</span></div>
                <div>Total do pedido: <span id="orderTotal">-</span></div>
                <div>Itens adicionais: <span id="orderBumpsBox">-</span></div>
                <div>Total de adicionais: <span id="orderBumpsTotal">-</span></div>
                <div>Número do pedido: <span id="orderNumberId"><%= String((order.fama24h && order.fama24h.orderId) || '-') %></span>
                  <button id="copyOrderBtn" class="copy-icon-btn" style="margin-left:8px;" aria-label="Copiar número do pedido">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <rect x="7" y="7" width="10" height="10" rx="2" fill="#1d4ed8"/>
                      <rect x="3" y="3" width="10" height="10" rx="2" fill="#1d4ed8" opacity="0.6"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="button-container" style="margin-top:0.75rem;">
              <button id="backToPrevBtn" class="continue-button" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; margin-right:0.5rem;">
                <span class="button-text">Voltar</span>
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script id="orderDataJson" type="application/json"><%= JSON.stringify(order || {}) %></script>
  <script>
    (function(){
      var orderData = {};
      try { orderData = JSON.parse(document.getElementById('orderDataJson').textContent || '{}'); } catch(_) {}
      var orderId = (orderData && orderData._id) ? String(orderData._id) : null;
      var hasFama = !!(orderData && orderData.fama24h && orderData.fama24h.orderId);
      try {
        var paidRaw = (orderData && orderData.woovi && orderData.woovi.paidAt) || orderData.paidAt || null;
        if (paidRaw) {
          var d = new Date(paidRaw);
          var spTime = new Date(d.getTime() - (3 * 60 * 60 * 1000));
          var dd = String(spTime.getUTCDate()).padStart(2,'0');
          var mm = String(spTime.getUTCMonth()+1).padStart(2,'0');
          var yyyy = spTime.getUTCFullYear();
          var hh = String(spTime.getUTCHours()).padStart(2,'0');
          var min = String(spTime.getUTCMinutes()).padStart(2,'0');
          var txt = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + min;
          var el = document.getElementById('paidAtLocal');
          if (el) el.textContent = txt;
        }
      } catch(_) {}
      function check() {
        var cachedOid = null;
        try { cachedOid = localStorage.getItem('oppus_selected_oid') || null; } catch(_) {}
        var orderIDParam = cachedOid || ((orderData && orderData.fama24h && orderData.fama24h.orderId) ? String(orderData.fama24h.orderId) : '');
        var baseUrl = orderIDParam ? ('/api/order?orderID=' + encodeURIComponent(orderIDParam)) : ('/api/order?id=' + encodeURIComponent(String(orderId || '')));
        var url = baseUrl;
        fetch(url)
          .then(function(r){return r.json();})
          .then(function(d){
            try {
              var o = d && d.order ? d.order : null;
              if (!o) return;
              var oid = (o.fama24h && o.fama24h.orderId) ? String(o.fama24h.orderId) : null;
              var paidRaw = (o.woovi && o.woovi.paidAt) || o.paidAt || null;
              var status = String(o.status || o.woovi && o.woovi.status || 'pendente');
              var tipo = String(o.tipo || o.tipoServico || '-');
              var qtd = String(o.qtd || o.quantidade || '0');
              var insta = String(o.instagramUsername || o.instauser || '-');
              var paidStr = null;
              if (paidRaw) {
                try {
                  var d0 = new Date(paidRaw);
                  var sp = new Date(d0.getTime() - (3*60*60*1000));
                  var dd = String(sp.getUTCDate()).padStart(2,'0');
                  var mm = String(sp.getUTCMonth()+1).padStart(2,'0');
                  var yyyy = sp.getUTCFullYear();
                  var hh = String(sp.getUTCHours()).padStart(2,'0');
                  var mn = String(sp.getUTCMinutes()).padStart(2,'0');
                  paidStr = dd + '/' + mm + '/' + yyyy + ' as ' + hh + ':' + mn;
                } catch(_) {}
              }
              var elNum = document.getElementById('orderNumberId');
              if (elNum && oid) elNum.textContent = String(oid);
              var elPaid = document.getElementById('paidAtLocal');
              if (elPaid && paidStr) elPaid.textContent = paidStr;
              var elSt = document.getElementById('orderStatus');
              if (elSt) {
                var s = String(status||'').toLowerCase();
                elSt.textContent = s==='pago' ? 'pedido pago' : status;
                try {
                  elSt.classList.toggle('status-green', s==='pago');
                  elSt.classList.toggle('status-yellow', s==='pendente');
                } catch(_) {}
              }
              var elTipo = document.getElementById('orderTipo');
              if (elTipo) elTipo.textContent = tipo;
              var elQtd = document.getElementById('orderQtd');
              if (elQtd) elQtd.textContent = String(qtd);
              var elUser = document.getElementById('orderInsta');
              if (elUser) elUser.textContent = insta;
              try {
                var getAddVal = function(obj, key){
                  var arrPaid = Array.isArray(obj && obj.additionalInfoPaid) ? obj.additionalInfoPaid : [];
                  var arr = Array.isArray(obj && obj.additionalInfo) ? obj.additionalInfo : [];
                  var mapPaid = obj && obj.additionalInfoMapPaid || {};
                  var foundPaid = arrPaid.find(function(it){ return it && it.key === key; });
                  if (foundPaid && typeof foundPaid.value === 'string') return foundPaid.value;
                  var found = arr.find(function(it){ return it && it.key === key; });
                  if (found && typeof found.value === 'string') return found.value;
                  if (mapPaid && typeof mapPaid[key] === 'string') return mapPaid[key];
                  return '';
                };
                var bumpsStr = getAddVal(o, 'order_bumps');
                var bumpsTotal = getAddVal(o, 'order_bumps_total');
                var baseCents = 0;
                try {
                  if (typeof o.valueCents === 'number') baseCents = o.valueCents;
                  else if (o.woovi && o.woovi.paymentMethods && o.woovi.paymentMethods.pix && typeof o.woovi.paymentMethods.pix.value === 'number') baseCents = o.woovi.paymentMethods.pix.value;
                } catch(_) {}
                var bumpsCents = 0;
                if (typeof bumpsTotal === 'string' && bumpsTotal) {
                  var m = bumpsTotal.match(/(\d+)[,\.]?(\d{0,2})/);
                  if (m) {
                    var whole = Number(m[1]);
                    var frac = String(m[2]||'');
                    var frac2 = frac.padEnd(2,'0').slice(0,2);
                    bumpsCents = (whole*100) + Number(frac2);
                  }
                }
                var totalCents = baseCents + bumpsCents;
                var totalStr = '-';
                if (totalCents > 0) {
                  var reais = Math.floor(totalCents/100);
                  var cents = String(totalCents%100).padStart(2,'0');
                  totalStr = 'R$ ' + reais + ',' + cents;
                }
                var elB = document.getElementById('orderBumpsBox');
                var elBT = document.getElementById('orderBumpsTotal');
                var elTot = document.getElementById('orderTotal');
                if (elBT) { elBT.textContent = bumpsTotal || '-'; }
                if (elTot) { elTot.textContent = totalStr; }
                if (elB) {
                  if (typeof bumpsStr === 'string' && bumpsStr) {
                    var parts = bumpsStr.split(';').map(function(p){ return p.trim(); }).filter(Boolean);
                    var labels = parts.map(function(p){
                      var kv = p.split(':');
                      var k = kv[0];
                      var v = kv[1];
                      if (k === 'views') return 'Visualizações (' + v + ')';
                      if (k === 'likes') return 'Curtidas (' + v + ')';
                      if (k === 'comments') return 'Comentários (' + v + ')';
                      return k + ' (' + v + ')';
                    });
                    elB.textContent = labels.join(', ');
                  } else {
                    elB.textContent = '-';
                  }
                }
              } catch(_) {}
            } catch(_){}
          })
          .catch(function(){});
      }
      setInterval(check, 8000);
      try { check(); } catch(_) {}
    })();
    (function initCopyOrder(){
      var btn = document.getElementById('copyOrderBtn');
      var span = document.getElementById('orderNumberId');
      if (!btn || !span) return;
      btn.addEventListener('click', function(){
        try {
          var val = (span.textContent || '').trim();
          if (!val) return;
          navigator.clipboard.writeText(val).then(function(){
            try { btn.classList.add('copied'); setTimeout(function(){ btn.classList.remove('copied'); }, 1200); } catch(_) {}
          });
        } catch(_) {}
      });
    })();
    (function initBackButton(){
      var btn = document.getElementById('backToPrevBtn');
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          if (window.history && window.history.length > 1) { window.history.back(); return; }
        } catch(_) {}
        try {
          var phone = localStorage.getItem('oppus_client_phone') || '';
          if (phone) { window.location.href = '/cliente'; return; }
        } catch(_) {}
        window.location.href = '/checkout';
      });
    })();
    (function initThemeToggle(){
      var btn = document.getElementById('themeToggleBtn');
      if (!btn) return;
      var applyLabel = function(){
        var isLight = document.body.classList.contains('theme-light');
        btn.textContent = isLight ? 'Tema: Escuro' : 'Tema: Claro';
      };
      try {
        var pref = localStorage.getItem('oppus_theme') || 'dark';
        document.body.classList.toggle('theme-light', pref === 'light');
      } catch(_) {}
      applyLabel();
      btn.addEventListener('click', function(){
        var isLight = document.body.classList.contains('theme-light');
        var next = isLight ? 'dark' : 'light';
        try { localStorage.setItem('oppus_theme', next); } catch(_) {}
        document.body.classList.toggle('theme-light', next === 'light');
        applyLabel();
      });
    })();
  </script>
</body>
</html>