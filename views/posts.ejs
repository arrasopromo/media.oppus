<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Posts do Instagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <link href="/css/perfil.css" rel="stylesheet" />
  <style>
    .media-box{position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:8px;background:#000}
    .media-thumb{width:100%;height:100%;object-fit:cover;display:block}
    .media-frame{position:absolute;inset:0;width:100%;height:100%;border:none;border-radius:8px}
    .selected-mark{outline:2px solid #7c3aed;border-radius:8px}
    .inline-msg{font-size:11px;color:var(--text-secondary);margin-top:6px}
    .selected-badge{position:absolute;top:8px;left:8px;background:var(--primary-color);color:#fff;font-size:11px;padding:4px 8px;border-radius:999px;display:none}
    .posts-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width: 640px){ .posts-grid{grid-template-columns:repeat(2,1fr)} #galleryCard{margin:0 auto;max-width:680px;width:100%} }
  </style>
</head>
<body>
  <div class="container checkout-page">
    <div class="site-brand" aria-label="Marca do site">
      <a href="/checkout" style="display:flex;align-items:center;gap:0.5rem;text-decoration:none;">
        <img src="/images/logo.png" alt="Agência Oppus" class="site-logo logo-dark" />
        <img src="/images/logo escura.png" alt="Agência Oppus" class="site-logo logo-light" />
        <span class="site-brand-text">Agência Oppus</span>
      </a>
    </div>
    <header class="header">
      <h1 class="title">Posts do Instagram</h1>
      <p class="subtitle">Últimos 8 posts de <span id="postsUser"><%= String(username || '-') %></span></p>
      <div style="display:flex;gap:0.5rem;align-items:center;">
        <input id="postsUsernameInput" type="text" placeholder="@usuario" value="<%= String(username || '') %>" style="padding:0.4rem;border-radius:6px;border:1px solid var(--border-color);" />
        <button id="loadPostsBtn" class="continue-button"><span class="button-text">Carregar</span></button>
      </div>
    </header>
    <main class="main-content">
      <section class="section-block">
        <div class="service-card" id="galleryCard">
          <div class="card-content">
            <h3 class="card-title">Galeria</h3>
            <div id="postsGrid" class="posts-grid"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script>
    (async function(){
      var selectedCache = [];
      function readLocalSelected(user){ try{ var raw = localStorage.getItem('ig_selected_posts'); if(!raw) return []; var obj = JSON.parse(raw); var arr = obj && obj[user]; return Array.isArray(arr)?arr:[]; }catch(_){ return []; } }
      function writeLocalSelected(user, arr){ try{ var raw = localStorage.getItem('ig_selected_posts'); var obj = raw?JSON.parse(raw):{}; obj[user] = Array.from(new Set(arr)); localStorage.setItem('ig_selected_posts', JSON.stringify(obj)); }catch(_){} }
      function normalizeUsername(input){
        if (!input) return '';
        var cleaned = String(input).trim().replace(/^@/,'');
        var m = cleaned.match(/^https?:\/\/(?:www\.)?instagram\.com\/([^\/?#]+)/i);
        return m ? m[1] : cleaned;
      }
      function fmt(ts){ try{ var d=new Date(Number(ts)*1000); return d.toLocaleString('pt-BR'); }catch(_){ return '-'; } }
      function render(posts){
        var grid = document.getElementById('postsGrid'); if (!grid) return;
        if (!Array.isArray(posts) || !posts.length) { grid.innerHTML = '<div>Nenhum post encontrado.</div>'; return; }
        grid.innerHTML = posts.map(function(p){
          var dsrc = p.displayUrl ? ('/image-proxy?url=' + encodeURIComponent(p.displayUrl)) : null;
          var vsrc = p.videoUrl ? ('/image-proxy?url=' + encodeURIComponent(p.videoUrl)) : null;
          var mediaHtml = (p.isVideo && vsrc)
            ? ('<div class="media-box"><div class="selected-badge">Selecionado</div><video src="'+vsrc+'" class="media-thumb" controls muted playsinline preload="metadata"></video></div>')
            : (dsrc
              ? ('<div class="media-box"><div class="selected-badge">Selecionado</div><img src="'+dsrc+'" class="media-thumb" alt="post"/></div>')
              : ('<div class="media-box"><div class="selected-badge">Selecionado</div><iframe src="https://www.instagram.com/p/'+p.shortcode+'/embed" class="media-frame" allowtransparency="true" allow="encrypted-media; picture-in-picture" scrolling="no"></iframe></div>'));
          return '<div class="service-card" style="margin:0;">\n' +
                   '<div class="card-content" data-shortcode="'+p.shortcode+'">\n' + mediaHtml + '\n' +
                   '<div class="inline-msg">'+fmt(p.takenAt)+'</div>\n' +
                   '<div style="margin-top:8px;display:flex;justify-content:center;align-items:center;">\n' +
                     '<button type="button" class="continue-button select-post-btn" style="width:100%" data-shortcode="'+p.shortcode+'">Selecionar</button>' +
                   '</div>\n' +
                 '</div>\n' +
                 '</div>';
        }).join('');
        try {
          var btns = grid.querySelectorAll('.select-post-btn');
          btns.forEach(function(btn){
            btn.addEventListener('click', async function(){
              var sc = this.getAttribute('data-shortcode');
              var user = document.getElementById('postsUser').textContent || '';
              try {
                var r = await fetch('/api/instagram/select-post', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: user, shortcode: sc }) });
                var d = await r.json();
                if (d && d.success && d.selectedPost) {
                  var card = this.closest('.card-content');
                  if (card) { card.classList.add('selected-mark'); var b2=card.querySelector('.selected-badge'); if(b2){ b2.style.display='inline-block'; } }
                  try { selectedCache = Array.isArray(d.selectedPosts) ? d.selectedPosts.map(function(it){ return it.shortcode; }) : selectedCache; } catch(_) {}
                  try { var u = document.getElementById('postsUser').textContent || ''; var current = readLocalSelected(u); writeLocalSelected(u, [sc].concat(current)); }catch(_){}
                  try { renderSelectedLog(); } catch(_){}
                }
              } catch(_){ }
            });
          });
        } catch(_) {}
      }
      async function renderSelectedLog(){
        var box = document.getElementById('selectedLog'); if (!box) return;
        try{ var r = await fetch('/api/instagram/selected-posts'); if(!r.ok) throw new Error('request_failed'); var d = await r.json(); var list = Array.isArray(d.posts)?d.posts:[];
          if (list.length) { selectedCache = list.map(function(it){ return it.shortcode; }); }
          var u = document.getElementById('postsUser').textContent || ''; var localArr = readLocalSelected(u);
          var source = (list.length ? list.map(function(it){ return it.shortcode; }) : (selectedCache.length?selectedCache:localArr));
          if (!source.length) { box.innerHTML = '<div class="inline-msg">Nenhum post selecionado ainda.</div>'; return; }
          box.innerHTML = source.map(function(sc){ var url = 'https://www.instagram.com/p/'+encodeURIComponent(sc)+'/'; return '<div style="padding:6px 8px;border:1px dashed var(--border-color);border-radius:6px;margin:4px 0;color:var(--text-primary);font-size:12px;">'+url+'</div>'; }).join('');
        }catch(_){
          var u = document.getElementById('postsUser').textContent || ''; var localArr = readLocalSelected(u);
          var source = selectedCache.length ? selectedCache : localArr;
          if (!source.length) { box.innerHTML = '<div class="inline-msg">Nenhum post selecionado ainda.</div>'; return; }
          box.innerHTML = source.map(function(sc){ var url = 'https://www.instagram.com/p/'+encodeURIComponent(sc)+'/'; return '<div style="padding:6px 8px;border:1px dashed var(--border-color);border-radius:6px;margin:4px 0;color:var(--text-primary);font-size:12px;">'+url+'</div>'; }).join('');
        }
      }
      async function markSelectedFromServer(){
        try{ var r = await fetch('/api/instagram/selected-posts'); var d = await r.json(); var list = Array.isArray(d.posts)?d.posts:[]; if(list.length){ selectedCache = list.map(function(it){ return it.shortcode; }); }
          var u = document.getElementById('postsUser').textContent || ''; var localArr = readLocalSelected(u);
          var grid = document.getElementById('postsGrid'); if(!grid) return; var codes = new Set((selectedCache.length?selectedCache:localArr));
          var cards = grid.querySelectorAll('.card-content'); cards.forEach(function(c){ var sc = c.getAttribute('data-shortcode'); if (codes.has(sc)) { c.classList.add('selected-mark'); var b=c.querySelector('.selected-badge'); if(b){ b.style.display='inline-block'; } } }); }catch(_){ }
      }
      async function load(u){
        if (!u) return;
        var user = normalizeUsername(u);
        document.getElementById('postsUser').textContent = user || '-';
        var url = '/api/instagram/posts?username=' + encodeURIComponent(user);
        try{ var r = await fetch(url); var d = await r.json(); if (d && d.success) { render(d.posts||[]); } else { render([]); } }catch(_){ render([]); }
      }
      try{ var inp=document.getElementById('postsUsernameInput'); var btn=document.getElementById('loadPostsBtn'); if(btn&&inp){ btn.addEventListener('click', function(){ load(inp.value||''); }); } }catch(_){}
      async function clearSelections(){ try{ await fetch('/api/instagram/selected-posts/clear', { method:'POST' }); var u = document.getElementById('postsUser').textContent || ''; writeLocalSelected(u, []); }catch(_){} }
      try{ var initial=document.getElementById('postsUsernameInput').value || ''; await clearSelections(); load(initial); }catch(_){ try{ load(initial); }catch(_){} }
      try{ markSelectedFromServer(); renderSelectedLog(); }catch(_){}
    })();
  </script>
  <div class="container checkout-page">
    <main class="main-content">
      <section class="section-block">
        <div class="service-card">
          <div class="card-content">
            <h3 class="card-title">Selecionados</h3>
            <div id="selectedLog"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
</body>
</html>